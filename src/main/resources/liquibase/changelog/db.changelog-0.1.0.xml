<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:pro="http://www.liquibase.org/xml/ns/pro"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd
      http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-3.8.xsd">

    <property name="defaultDate" value="now()::timestamp(0)" dbms="postgresql"/>

    <changeSet id="1" author="kborodulin">
        <createTable tableName="role" remarks="Роль">
            <column name="roleid" type="bigint" remarks="Идентификатор">
                <constraints primaryKey="true"></constraints>
            </column>
            <column name="name" type="varchar(255)" remarks="Наименование">
                <constraints nullable="false"/>
            </column>
            <column name="brief" type="varchar(255)" remarks="Сокращение">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="2" author="kborodulin">
        <createIndex tableName="role" indexName="idx_role_name" unique="true">
            <column name="name"></column>
        </createIndex>
        <createIndex tableName="role" indexName="idx_role_brief" unique="true">
            <column name="brief">brief</column>
        </createIndex>
    </changeSet>

    <changeSet id="3" runInTransaction="true" author="kborodulin">
        <insert tableName="role">
            <column name="roleid" value="1"/>
            <column name="name" value="Пользователь"/>
            <column name="brief" value="user"/>
        </insert>
        <insert tableName="role">
            <column name="roleid" value="2"/>
            <column name="name" value="Администратор"/>
            <column name="brief" value="admin"/>
        </insert>
    </changeSet>

    <changeSet id="4" author="kborodulin">
        <createTable tableName="users" remarks="Пользователь">
            <column name="userid" type="bigint" remarks="Идентификатор">
                <constraints primaryKey="true"></constraints>
            </column>
            <column name="datecreate" type="timestamp()" defaultValueDate="${defaultDate}"
                    remarks="Дата создания пользователя">
                <constraints nullable="false"/>
            </column>
            <column name="login" type="varchar(255)" remarks="Логин пользователя">
                <constraints nullable="false"/>
            </column>
            <column name="password" type="varchar(255)" remarks="Пароль пользователя">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="varchar(255)" remarks="Электронная почта"/>
            <column name="isblock" type="int" defaultValue="0" remarks="Признак блокировки пользователя">
                <constraints nullable="false"/>
            </column>
            <column name="roleid" type="bigint" defaultValue="1" remarks="Роль">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint
                baseTableName="users"
                baseColumnNames="roleid"
                constraintName="fk_user_roleid"
                referencedTableName="role"
                referencedColumnNames="roleid"/>
    </changeSet>

    <changeSet id="5" author="kborodulin">
        <createIndex tableName="users" indexName="idx_users_login" unique="true">
            <column name="login"></column>
        </createIndex>
        <createIndex tableName="users" indexName="idx_users_email" unique="true">
            <column name="email"></column>
        </createIndex>
    </changeSet>

    <changeSet id="6" runInTransaction="true" author="kborodulin">
        <insert tableName="users">
            <column name="userid" value="1"/>
            <column name="login" value="test"/>
            <column name="password" value="1"/>
            <column name="email" value="test@test.ru"/>
        </insert>
        <insert tableName="users">
            <column name="userid" value="2"/>
            <column name="login" value="info"/>
            <column name="password" value="1"/>
            <column name="email" value="info@info.ru"/>
        </insert>
        <insert tableName="users">
            <column name="userid" value="3"/>
            <column name="login" value="menext"/>
            <column name="password" value="1"/>
            <column name="email" value="menext@menext.ru"/>
        </insert>
        <insert tableName="users">
            <column name="userid" value="4"/>
            <column name="login" value="flex"/>
            <column name="password" value="1"/>
            <column name="email" value="flex@flex.ru"/>
        </insert>
        <insert tableName="users">
            <column name="userid" value="5"/>
            <column name="login" value="mtt"/>
            <column name="password" value="1"/>
            <column name="email" value="mtt@mtt.ru"/>
        </insert>
    </changeSet>

    <changeSet id="7" author="kborodulin">
        <sql>
            create table family (
            familyid bigint not null,
            name varchar(255) not null,
            constraint family_pkey primary key (familyid)
            );
            comment on table family is 'семья';
            comment on column family.familyid is 'идентификатор';
            comment on column role.name is 'наименование';
        </sql>
    </changeSet>

    <changeSet id="8" author="kborodulin">
        <sql>
            insert into family(familyid, name) values('1', 'Ивановы');
            insert into family(familyid, name) values('2', 'Петровы');
            insert into family(familyid, name) values('3', 'Казаковы');
        </sql>
    </changeSet>

    <changeSet id="9" author="kborodulin">
        <sql>
            create table kinship (
            kinshipid bigint not null,
            name varchar(255),
            brief varchar(255),
            constraint kinship_pkey primary key (kinshipid)
            );
        </sql>
    </changeSet>

    <changeSet id="10" author="kborodulin">
        <sql>
            insert into kinship(kinshipid, name, brief)
            values(1, 'Отец', 'Father');
            insert into kinship(kinshipid, name, brief)
            values(2, 'Мать', 'Mother');
            insert into kinship(kinshipid, name, brief)
            values(3, 'Сын', 'Son');
            insert into kinship(kinshipid, name, brief)
            values(4, 'Дочь', 'Daughter');
            insert into kinship(kinshipid, name, brief)
            values(5, 'Бабушка', 'Grandmother');
            insert into kinship(kinshipid, name, brief)
            values(6, 'Дедушка', 'Grandfather');
        </sql>
    </changeSet>

    <changeSet id="11" author="kborodulin">
        <sql>
            create table famem (
            famemid bigint not null,
            surname varchar(255),
            name varchar(255),
            patronymic varchar(255),
            datebirth timestamp,
            shortname varchar(255),
            familyid bigint,
            userid bigint,
            kinshipid bigint,
            constraint famem_pkey primary key (famemid),
            constraint "fk_famem_familyid" foreign key ("familyid") references "family" ("familyid"),
            constraint "fk_famem_userid" foreign key ("userid") references "users" ("userid"),
            constraint "fk_famem_kinshipid" foreign key ("kinshipid") references "kinship" ("kinshipid")
            );
            create unique index "idx_famem_shortname" on "famem"("shortname");
        </sql>
    </changeSet>

    <changeSet id="12" author="kborodulin">
        <sql>
            insert into famem (famemid, surname, name, patronymic, datebirth, shortname, familyid, userid, kinshipid)
            values(1, 'Иванов', 'Иван', 'Иванович', '10.10.2000', 'Ваня', 1, 1, 3);
            insert into famem (famemid, surname, name, patronymic, datebirth, shortname, familyid, userid, kinshipid)
            values(2, 'Иванова', 'Мария', 'Ивановна', '10.10.2005', 'Маша', 1, 2, 4);
        </sql>
    </changeSet>

    <changeSet id="13" author="kborodulin">
        <sql>
            create table accounttype (
            accounttypeid bigint not null,
            name varchar(255) not null,
            brief varchar(255) not null,
            constraint accounttype_pkey primary key (accounttypeid)
            );
        </sql>
    </changeSet>

    <changeSet id="14" author="kborodulin">
        <sql>
            insert into accounttype(accounttypeid, name, brief)
            values (1, 'Наличные', 'cash');
            insert into accounttype(accounttypeid, name, brief)
            values (2, 'Банковский вклад', 'deposits');
            insert into accounttype(accounttypeid, name, brief)
            values (3, 'Кредит', 'credit');
            insert into accounttype(accounttypeid, name, brief)
            values (4, 'Дебетовая карта', 'debitcard');
            insert into accounttype(accounttypeid, name, brief)
            values (5, 'Кредитная карта', 'creditcard');
        </sql>
    </changeSet>

    <changeSet id="15" author="kborodulin">
        <sql>
            create table currency (
            currencyid bigint not null,
            name varchar(255) not null,
            brief varchar(255) not null,
            constraint currency_pkey primary key (currencyid)
            );
        </sql>
    </changeSet>

    <changeSet id="16" author="kborodulin">
        <sql>
            insert into currency(currencyid, name, brief)
            values(1, 'Рубль', 'rub');
            insert into currency(currencyid, name, brief)
            values(2, 'Доллар', 'usd');
            insert into currency(currencyid, name, brief)
            values(3, 'euro', 'euro');
        </sql>
    </changeSet>

    <changeSet id="17" author="kborodulin">
        <sql>
            create table account (
            accountid bigint not null,
            num numeric,
            amount numeric,
            dateopen date,
            accountopenorg varchar(255),
            isclosesign numeric(1) default 0,
            famemid bigint,
            accounttypeid bigint,
            currencyid bigint,
            constraint account_pkey primary key (accountid),
            constraint "fk_account_famemid" foreign key ("famemid") references "famem" ("famemid"),
            constraint "fk_account_accounttypeid" foreign key ("accounttypeid") references "accounttype"
            ("accounttypeid"),
            constraint "fk_account_currencyid" foreign key ("currencyid") references "currency" ("currencyid")
            );
        </sql>
    </changeSet>

    <changeSet id="18" author="kborodulin">
        <sql>
            insert into account(accountid, num, amount, dateopen, accountopenorg, isclosesign, famemid, accounttypeid,
            currencyid)
            values(1, 42151723423, 1000, '10.11.2015', 'Сбер', 0, 1, 4, 1);
            insert into account(accountid, num, amount, dateopen, accountopenorg, isclosesign, famemid, accounttypeid,
            currencyid)
            values(2, 124124143, 2000, '10.11.2015', 'Сбер', 0, 2, 4, 1);
        </sql>
    </changeSet>

    <changeSet id="19" author="kborodulin">
        <sql>
            create table category (
            categoryid bigint not null,
            name varchar(255) not null,
            brief varchar(255) not null,
            constraint category_pkey primary key (categoryid)
            );
        </sql>
    </changeSet>

    <changeSet id="20" author="kborodulin">
        <sql>
            insert into category(categoryid, name, brief)
            values(1, 'Работа', 'work');
            insert into category(categoryid, name, brief)
            values(2, 'Кредит', 'credit');
            insert into category(categoryid, name, brief)
            values(3, 'Депозит', 'deposit');
            insert into category(categoryid, name, brief)
            values(4, 'Коммуналка', 'communal');
            insert into category(categoryid, name, brief)
            values(5, 'Телефон', 'phone');
            insert into category(categoryid, name, brief)
            values(6, 'Интернет', 'internet');
            insert into category(categoryid, name, brief)
            values(7, 'Транспорт', 'transport');
            insert into category(categoryid, name, brief)
            values(8, 'Супермаркет', 'supermarket');
            insert into category(categoryid, name, brief)
            values(9, 'Медицина', 'medicine');
            insert into category(categoryid, name, brief)
            values(10, 'Одежда', 'clothing');
            insert into category(categoryid, name, brief)
            values(11, 'Кино', 'cinema');
            insert into category(categoryid, name, brief)
            values(12, 'Кафе', 'cafe');
            insert into category(categoryid, name, brief)
            values(13, 'Подарки', 'gifts');
            insert into category(categoryid, name, brief)
            values(14, 'Перевод между своими счетами', 'transfer');
            insert into category(categoryid, name, brief)
            values(15, 'Прочее', 'other');
        </sql>
    </changeSet>

    <changeSet id="21" author="kborodulin">
        <sql>
            create table typeoperation (
            typeoperationid bigint not null,
            name varchar(255) not null,
            brief varchar(255) not null,
            constraint typeoperationid_pkey primary key (typeoperationid)
            );
        </sql>
    </changeSet>

    <changeSet id="22" author="kborodulin">
        <sql>
            insert into typeoperation(typeoperationid, name, brief)
            values(1, 'Доход', 'income');
            insert into typeoperation(typeoperationid, name, brief)
            values(2, 'Расход', 'outlay');
        </sql>
    </changeSet>

    <changeSet id="23" author="kborodulin">
        <sql>
            create table operation (
            operationid bigint not null,
            typeoperationid bigint,
            categoryid bigint,
            accountid bigint,
            amount numeric,
            dateoper timestamp,
            datewritedb timestamp,
            comment varchar(1000),
            constraint operation_pkey primary key (operationid),
            constraint "fk_operation_typeoperationid" foreign key ("typeoperationid") references "typeoperation"
            ("typeoperationid"),
            constraint "fk_operation_categoryid" foreign key ("categoryid") references "category" ("categoryid"),
            constraint "fk_operation_accountid" foreign key ("accountid") references "account" ("accountid")
            );
        </sql>
    </changeSet>

    <changeSet id="24" author="kborodulin">
        <sql>
            insert into operation(operationid, typeoperationid, categoryid, accountid, amount, dateoper, datewritedb)
            values(1, 2, 5, 1, 100, '01.01.2020', '01.01.2020');
            insert into operation(operationid, typeoperationid, categoryid, accountid, amount, dateoper, datewritedb)
            values(2, 2, 5, 1, 200, '01.02.2020', '01.02.2020');
        </sql>
    </changeSet>

    <changeSet id="25" author="kborodulin">
        <sql>
            create table alert (
            alertid bigint not null,
            datealert timestamp,
            alertinitid bigint,
            familyid bigint,
            famemid bigint,
            status numeric(1),
            isalertsignproc numeric(1),
            constraint alert_pkey primary key (alertid),
            constraint "fk_alert_alertinitid" foreign key ("alertinitid") references "famem" ("famemid"),
            constraint "fk_alert_familyid" foreign key ("familyid") references "family" ("familyid"),
            constraint "fk_alert_famemid" foreign key ("famemid") references "famem" ("famemid")
            );
        </sql>
    </changeSet>

    <changeSet id="26" author="kborodulin">
        <sql>
            insert into alert(alertid, datealert, alertinitid, familyid, famemid, status, isalertsignproc)
            values(1, '01.01.2020', 1, 1, 1, 1, 1);
            insert into alert(alertid, datealert, alertinitid, familyid, famemid, status, isalertsignproc)
            values(2, '01.01.2020', 1, 2, 1, 1, 1);
        </sql>
    </changeSet>

    <changeSet id="27" author="kborodulin">
        <sql>
            alter table account add name varchar(255);
        </sql>
    </changeSet>

    <changeSet id="28" author="kborodulin">
        <sql>
            alter table users alter column userid add generated always as identity;
        </sql>
    </changeSet>
</databaseChangeLog>